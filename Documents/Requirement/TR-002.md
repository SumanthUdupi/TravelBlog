# TR-002: Database Schema

Status: ENHANCED

## Overview
As a Database Architect, I need a robust, scalable database schema that efficiently stores and retrieves complex content structures, supports advanced tagging systems, and ensures data integrity for a scholarly publishing platform. This requirement defines the relational data model for posts, users, tags, and moderation systems.

## Business Value
A well-designed database schema enables fast query performance, data consistency, and scalable growth, directly impacting user experience and operational efficiency. By implementing proper indexing, normalization, and JSON support for flexible content, we ensure reliable content delivery, powerful search capabilities, and the ability to handle complex relationships between scholarly works.

## Target Audience
- Primary: Backend developers, database administrators, and data engineers
- Secondary: Content managers, product managers, and system analysts
- Tertiary: Business analysts interested in data-driven insights

## Value Propositions
- **Performance**: Optimized queries with strategic indexing for fast content retrieval
- **Flexibility**: JSONB support for complex content structures and dynamic metadata
- **Scalability**: Designed for horizontal scaling and large dataset management
- **Integrity**: Referential constraints and validation rules ensuring data quality
- **Analytics**: Structured data enabling rich reporting and content insights

## Revenue Model
- Indirect: Supports premium features like advanced search, analytics, and personalized recommendations
- Cost Efficiency: Optimized schema reduces storage costs and improves query performance
- Data Monetization: Enables data-driven features that enhance user engagement and retention

## Success Metrics
- **Query Performance**: Average response time <100ms for common queries
- **Scalability**: Support for 1M+ posts with consistent performance
- **Data Integrity**: Zero data corruption incidents, 100% referential integrity
- **Search Accuracy**: >95% relevance in full-text search results
- **Uptime**: Database availability >99.99%

## Visual/Interactive Specifications
- **Content Management Interface**: Intuitive admin panels for content CRUD operations
- **Tag Visualization**: Interactive constellation maps showing tag relationships
- **Search Interface**: Faceted search with real-time filtering and autocomplete
- **Analytics Dashboard**: Visual reports on content performance and user engagement
- **Moderation Queue**: Streamlined interface for content review and flagging

## Technical Considerations
- **Database Engine**: PostgreSQL with advanced features (JSONB, full-text search, partitioning)
- **Indexing Strategy**: GIN indexes for JSON, B-tree for relational queries
- **Backup & Recovery**: Automated backups with point-in-time recovery
- **Security**: Row-level security, encryption at rest, audit logging
- **Migration**: Version-controlled schema migrations with rollback capabilities

## Technical Specifications

### Core Tables

**Posts Table**:
```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug VARCHAR(255) UNIQUE NOT NULL,
  title VARCHAR(500) NOT NULL,
  author_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  body JSONB NOT NULL, -- Tiptap JSON structure for rich content
  constellation_tags JSONB DEFAULT '{}', -- {era_id, domain_id, humor_id}
  atmosphere_config JSONB DEFAULT '{}', -- Default theme, audio, triggers
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'archived')),
  published_at TIMESTAMP WITH TIME ZONE,
  read_time_minutes INTEGER,
  word_count INTEGER,
  excerpt TEXT,
  featured_image_url VARCHAR(500),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Performance indexes
CREATE INDEX idx_posts_tags ON posts USING GIN (constellation_tags);
CREATE INDEX idx_posts_published ON posts (published_at DESC) WHERE status='published';
CREATE INDEX idx_posts_author ON posts (author_id);
CREATE INDEX idx_posts_status ON posts (status);
CREATE INDEX idx_posts_slug ON posts (slug);
```

**Constellation Tags Table**:
```sql
CREATE TABLE constellation_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type VARCHAR(20) NOT NULL CHECK (type IN ('era', 'domain', 'humor')),
  slug VARCHAR(100) UNIQUE NOT NULL,
  label VARCHAR(200) NOT NULL,
  color CHAR(7) NOT NULL, -- Hex code for visualization
  parent_id UUID REFERENCES constellation_tags(id), -- For hierarchical domains
  metadata JSONB DEFAULT '{}', -- {range, icon, description, weight}
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indexes for tag queries
CREATE INDEX idx_tags_type ON constellation_tags (type);
CREATE INDEX idx_tags_parent ON constellation_tags (parent_id);
CREATE INDEX idx_tags_active ON constellation_tags (is_active);
```

**Glossary Terms Table**:
```sql
CREATE TABLE glossary_terms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  term VARCHAR(200) UNIQUE NOT NULL,
  definition TEXT NOT NULL,
  post_id UUID REFERENCES posts(id) ON DELETE SET NULL, -- Where first defined
  usage_count INTEGER DEFAULT 0,
  pronunciation VARCHAR(200),
  synonyms TEXT[], -- Array of related terms
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Search optimization
CREATE INDEX idx_glossary_term ON glossary_terms USING GIN (to_tsvector('english', term));
CREATE INDEX idx_glossary_usage ON glossary_terms (usage_count DESC);
```

**Moderation Table**:
```sql
CREATE TABLE moderation_flags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id), -- Who flagged
  reason VARCHAR(50) NOT NULL CHECK (reason IN ('spam', 'harassment', 'inappropriate', 'copyright', 'factual_error')),
  severity VARCHAR(10) DEFAULT 'medium' CHECK (severity IN ('low', 'medium', 'high')),
  description TEXT,
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'investigating', 'resolved', 'dismissed')),
  resolved_by UUID REFERENCES users(id),
  resolved_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Moderation workflow indexes
CREATE INDEX idx_moderation_post ON moderation_flags (post_id);
CREATE INDEX idx_moderation_status ON moderation_flags (status);
CREATE INDEX idx_moderation_severity ON moderation_flags (severity DESC);
```

## Implementation Notes
- **Normalization**: Balanced approach with JSONB for flexibility vs. relational integrity
- **Partitioning**: Time-based partitioning for large tables (posts, moderation_flags)
- **Triggers**: Automatic updated_at timestamps and usage count increments
- **Constraints**: Comprehensive check constraints and foreign key relationships
- **Extensions**: Enable PostgreSQL extensions (uuid-ossp, pg_trgm for fuzzy search)

## Risks and Mitigations
- **Data Corruption**: Mitigation - Regular backups, WAL archiving, and integrity checks
- **Performance Degradation**: Mitigation - Query optimization, index maintenance, and monitoring
- **Schema Evolution**: Mitigation - Version-controlled migrations with testing and rollback plans
- **Scalability Limits**: Mitigation - Horizontal scaling design, read replicas, and caching layers
- **Data Privacy**: Mitigation - Encryption, access controls, and compliance with data protection regulations